# å®æˆ˜æ¡ˆä¾‹ï¼šè®¢å•å¤„ç†ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è®¢å•å¤„ç†ç³»ç»Ÿç¤ºä¾‹ï¼Œå±•ç¤ºäº† Kafka åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­çš„åº”ç”¨ã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¢å•æœåŠ¡   â”‚â”€â”€â”€â”€>â”‚ order-events â”‚â”€â”€â”€â”€>â”‚  åº“å­˜æœåŠ¡     â”‚
â”‚ (Producer)  â”‚     â”‚    Topic     â”‚     â”‚ (Consumer)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ”¯ä»˜æœåŠ¡     â”‚
                    â”‚ (Consumer)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ notification â”‚
                    â”‚    Topic     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸šåŠ¡æµç¨‹

1. **è®¢å•åˆ›å»º**: ç”¨æˆ·åˆ›å»ºè®¢å•ï¼Œå‘é€ `OrderCreated` äº‹ä»¶
2. **åº“å­˜æ‰£å‡**: åº“å­˜æœåŠ¡ç›‘å¬è®¢å•äº‹ä»¶ï¼Œæ‰£å‡åº“å­˜
3. **æ”¯ä»˜å¤„ç†**: æ”¯ä»˜æœåŠ¡å¤„ç†è®¢å•æ”¯ä»˜
4. **é€šçŸ¥å‘é€**: æ”¯ä»˜æˆåŠŸåå‘é€é€šçŸ¥ç»™ç”¨æˆ·

## æ–‡ä»¶ç»“æ„

```
examples/08-order-processing/
â”œâ”€â”€ README.md
â”œâ”€â”€ main.go                  # ä¸»ç¨‹åºï¼ˆè®¢å•æœåŠ¡ï¼‰
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ service.go          # åº“å­˜æœåŠ¡
â”œâ”€â”€ payment/
â”‚   â””â”€â”€ service.go          # æ”¯ä»˜æœåŠ¡
â”œâ”€â”€ notification/
â”‚   â””â”€â”€ service.go          # é€šçŸ¥æœåŠ¡
â””â”€â”€ models/
    â””â”€â”€ events.go           # äº‹ä»¶æ¨¡å‹
```

## äº‹ä»¶ç±»å‹

### OrderCreated äº‹ä»¶
```json
{
  "event_type": "OrderCreated",
  "order_id": "ORD-123456",
  "user_id": "USER-001",
  "items": [
    {
      "product_id": "PROD-001",
      "quantity": 2,
      "price": 99.99
    }
  ],
  "total_amount": 199.98,
  "timestamp": "2025-11-06T10:30:00Z"
}
```

### InventoryReserved äº‹ä»¶
```json
{
  "event_type": "InventoryReserved",
  "order_id": "ORD-123456",
  "reservation_id": "RSV-789",
  "status": "success",
  "timestamp": "2025-11-06T10:30:01Z"
}
```

### PaymentCompleted äº‹ä»¶
```json
{
  "event_type": "PaymentCompleted",
  "order_id": "ORD-123456",
  "payment_id": "PAY-456",
  "status": "success",
  "amount": 199.98,
  "timestamp": "2025-11-06T10:30:02Z"
}
```

## è¿è¡Œç¤ºä¾‹

### 1. å¯åŠ¨ Kafka

```bash
docker-compose up -d
```

### 2. å¯åŠ¨å„ä¸ªæœåŠ¡

```bash
# ç»ˆç«¯ 1: å¯åŠ¨åº“å­˜æœåŠ¡
go run examples/08-order-processing/inventory/service.go

# ç»ˆç«¯ 2: å¯åŠ¨æ”¯ä»˜æœåŠ¡
go run examples/08-order-processing/payment/service.go

# ç»ˆç«¯ 3: å¯åŠ¨é€šçŸ¥æœåŠ¡
go run examples/08-order-processing/notification/service.go

# ç»ˆç«¯ 4: å¯åŠ¨è®¢å•æœåŠ¡ï¼ˆåˆ›å»ºè®¢å•ï¼‰
go run examples/08-order-processing/main.go
```

### 3. è§‚å¯Ÿæ—¥å¿—

æ¯ä¸ªæœåŠ¡éƒ½ä¼šæ‰“å°è¯¦ç»†çš„å¤„ç†æ—¥å¿—ï¼Œå±•ç¤ºäº‹ä»¶æµè½¬è¿‡ç¨‹ã€‚

## å…³é”®ç‰¹æ€§

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„

- æœåŠ¡ä¹‹é—´é€šè¿‡äº‹ä»¶è§£è€¦
- å¼‚æ­¥å¤„ç†ï¼Œæé«˜ç³»ç»Ÿååé‡
- æ˜“äºæ‰©å±•æ–°æœåŠ¡

### 2. æ¶ˆæ¯æœ‰åºæ€§

- ä½¿ç”¨è®¢å• ID ä½œä¸ºæ¶ˆæ¯ Key
- ç¡®ä¿åŒä¸€è®¢å•çš„äº‹ä»¶æœ‰åºå¤„ç†

### 3. é”™è¯¯å¤„ç†

- é‡è¯•æœºåˆ¶
- æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰
- è¡¥å¿äº‹åŠ¡

### 4. å¹‚ç­‰æ€§

- ä½¿ç”¨äº‹ä»¶ ID å»é‡
- çŠ¶æ€æœºç®¡ç†è®¢å•çŠ¶æ€

### 5. ç›‘æ§æŒ‡æ ‡

- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
- å¤±è´¥ç‡
- ååé‡

## æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ è®¢å•å–æ¶ˆæµç¨‹

```go
type OrderCancelled struct {
    OrderID   string
    Reason    string
    Timestamp time.Time
}
```

### 2. å®ç°è¡¥å¿äº‹åŠ¡

å¦‚æœæ”¯ä»˜å¤±è´¥ï¼Œéœ€è¦é‡Šæ”¾åº“å­˜ï¼š

```go
type InventoryReleased struct {
    OrderID       string
    ReservationID string
    Timestamp     time.Time
}
```

### 3. æ·»åŠ è®¢å•çŠ¶æ€è¿½è¸ª

ä½¿ç”¨ Kafka Streams æˆ–ç‹¬ç«‹æœåŠ¡èšåˆè®¢å•çŠ¶æ€ã€‚

### 4. å®ç° Saga æ¨¡å¼

åè°ƒå¤šä¸ªæœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡å¤„ç†

```go
// æ‰¹é‡æ‰£å‡åº“å­˜
func (s *InventoryService) processBatch(orders []*OrderCreated) error {
    // æ‰¹é‡æ•°æ®åº“æ“ä½œ
    return s.db.BatchUpdateInventory(orders)
}
```

### 2. å¹¶å‘å¤„ç†

```go
// ä½¿ç”¨ Worker Pool
for i := 0; i < numWorkers; i++ {
    go s.worker(messages)
}
```

### 3. ç¼“å­˜

```go
// ç¼“å­˜åº“å­˜ä¿¡æ¯
inventory := cache.Get(productID)
if inventory == nil {
    inventory = db.GetInventory(productID)
    cache.Set(productID, inventory, 5*time.Minute)
}
```

## ç›‘æ§ä¸å‘Šè­¦

### å…³é”®æŒ‡æ ‡

```
- è®¢å•å¤„ç†å»¶è¿Ÿ (P95, P99)
- åº“å­˜æ‰£å‡æˆåŠŸç‡
- æ”¯ä»˜æˆåŠŸç‡
- æ¶ˆæ¯ç§¯å‹ (Lag)
- æœåŠ¡å¯ç”¨æ€§
```

### å‘Šè­¦è§„åˆ™

```
- Lag > 1000: æ¶ˆè´¹é€Ÿåº¦æ…¢ï¼Œéœ€è¦æ‰©å®¹
- å¤±è´¥ç‡ > 1%: æœåŠ¡å¼‚å¸¸ï¼Œéœ€è¦æ’æŸ¥
- å¤„ç†å»¶è¿Ÿ > 5s: æ€§èƒ½é—®é¢˜
```

## æµ‹è¯•

### å‹åŠ›æµ‹è¯•

```bash
# åˆ›å»º 1000 ä¸ªè®¢å•
go run examples/08-order-processing/main.go -orders=1000
```

### æ•…éšœæµ‹è¯•

```bash
# æ¨¡æ‹Ÿæ”¯ä»˜æœåŠ¡å®•æœº
pkill -f payment/service.go

# è§‚å¯Ÿé‡è¯•å’Œé”™è¯¯å¤„ç†
```

## æœ€ä½³å®è·µ

1. âœ… **ä½¿ç”¨æ¶ˆæ¯ Key ä¿è¯é¡ºåº**: åŒä¸€è®¢å•çš„äº‹ä»¶ä½¿ç”¨ç›¸åŒçš„ Key
2. âœ… **å¹‚ç­‰æ€§è®¾è®¡**: æ¶ˆæ¯å¯èƒ½é‡å¤æ¶ˆè´¹ï¼Œéœ€è¦å»é‡
3. âœ… **ç‰ˆæœ¬æ§åˆ¶**: æ¶ˆæ¯æ ¼å¼æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ”¯æŒå¹³æ»‘å‡çº§
4. âœ… **ç›‘æ§å‘Šè­¦**: å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
5. âœ… **æ•…éšœæ¢å¤**: å®ç°é‡è¯•å’Œè¡¥å¿æœºåˆ¶
6. âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹å¤„ç†ã€å¹¶å‘ã€ç¼“å­˜
7. âœ… **æ—¥å¿—è¿½è¸ª**: æ·»åŠ  TraceID è¿½è¸ªæ•´ä¸ªæµç¨‹

## ä¸‹ä¸€æ­¥

- ğŸ“– å­¦ä¹  [Kafka äº‹åŠ¡](../05-transactions/)
- ğŸ“– å­¦ä¹  [Kafka Streams](../09-kafka-streams/)
- ğŸ’» å®ç°æ›´å¤šå®æˆ˜æ¡ˆä¾‹

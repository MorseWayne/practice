# Makefile for Kafka Demo Project

.PHONY: help setup start stop clean install test producer consumer

# é»˜è®¤ç›®æ ‡
help:
	@echo "Kafka + Go å­¦ä¹ é¡¹ç›®"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make setup       - åˆå§‹åŒ–é¡¹ç›®ï¼ˆä¸‹è½½ä¾èµ–ï¼‰"
	@echo "  make start       - å¯åŠ¨ Kafka é›†ç¾¤"
	@echo "  make stop        - åœæ­¢ Kafka é›†ç¾¤"
	@echo "  make restart     - é‡å¯ Kafka é›†ç¾¤"
	@echo "  make clean       - æ¸…ç†æ‰€æœ‰æ•°æ®"
	@echo "  make logs        - æŸ¥çœ‹ Kafka æ—¥å¿—"
	@echo "  make status      - æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"
	@echo ""
	@echo "ç¤ºä¾‹è¿è¡Œ:"
	@echo "  make producer    - è¿è¡Œç®€å•ç”Ÿäº§è€…"
	@echo "  make consumer    - è¿è¡Œç®€å•æ¶ˆè´¹è€…"
	@echo "  make async       - è¿è¡Œå¼‚æ­¥ç”Ÿäº§è€…"
	@echo "  make batch       - è¿è¡Œæ‰¹é‡æ¶ˆè´¹è€…"
	@echo "  make order       - è¿è¡Œè®¢å•å¤„ç†ç³»ç»Ÿ"
	@echo ""
	@echo "Kafka ç®¡ç†:"
	@echo "  make topics      - åˆ—å‡ºæ‰€æœ‰ Topic"
	@echo "  make groups      - åˆ—å‡ºæ‰€æœ‰æ¶ˆè´¹è€…ç»„"
	@echo "  make ui          - æ‰“å¼€ Kafka UI"

# åˆå§‹åŒ–é¡¹ç›®
setup:
	@echo "ğŸ“¦ ä¸‹è½½ Go ä¾èµ–..."
	go mod download
	go mod tidy
	@echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"

# å¯åŠ¨ Kafka é›†ç¾¤
start:
	@echo "ğŸš€ å¯åŠ¨ Kafka é›†ç¾¤..."
	docker-compose up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
	@sleep 30
	@echo "âœ… Kafka é›†ç¾¤å·²å¯åŠ¨"
	@echo "   Kafka UI: http://localhost:8080"
	@echo "   Kafdrop:  http://localhost:9000"

# åœæ­¢ Kafka é›†ç¾¤
stop:
	@echo "â¸ï¸  åœæ­¢ Kafka é›†ç¾¤..."
	docker-compose stop
	@echo "âœ… Kafka é›†ç¾¤å·²åœæ­¢"

# é‡å¯ Kafka é›†ç¾¤
restart: stop start

# æ¸…ç†æ•°æ®å’Œå®¹å™¨
clean:
	@echo "ğŸ§¹ æ¸…ç† Kafka é›†ç¾¤å’Œæ•°æ®..."
	docker-compose down -v
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æŸ¥çœ‹æ—¥å¿—
logs:
	docker-compose logs -f

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
status:
	@echo "ğŸ“Š é›†ç¾¤çŠ¶æ€:"
	@docker-compose ps

# åˆ—å‡ºæ‰€æœ‰ Topic
topics:
	@echo "ğŸ“‹ Topic åˆ—è¡¨:"
	@docker exec kafka1 kafka-topics.sh --list --bootstrap-server localhost:9092

# åˆ—å‡ºæ‰€æœ‰æ¶ˆè´¹è€…ç»„
groups:
	@echo "ğŸ‘¥ æ¶ˆè´¹è€…ç»„åˆ—è¡¨:"
	@docker exec kafka1 kafka-consumer-groups.sh --list --bootstrap-server localhost:9092

# æ‰“å¼€ Kafka UI
ui:
	@echo "ğŸŒ æ‰“å¼€ Kafka UI..."
	@open http://localhost:8080 2>/dev/null || xdg-open http://localhost:8080 2>/dev/null || echo "è¯·æ‰‹åŠ¨æ‰“å¼€: http://localhost:8080"

# è¿è¡Œç®€å•ç”Ÿäº§è€…
producer:
	@echo "ğŸ”µ è¿è¡Œç®€å•ç”Ÿäº§è€…..."
	go run examples/01-simple-producer/main.go

# è¿è¡Œç®€å•æ¶ˆè´¹è€…
consumer:
	@echo "ğŸŸ¢ è¿è¡Œç®€å•æ¶ˆè´¹è€…..."
	go run examples/02-simple-consumer/main.go

# è¿è¡Œå¼‚æ­¥ç”Ÿäº§è€…
async:
	@echo "ğŸ”µ è¿è¡Œå¼‚æ­¥ç”Ÿäº§è€…..."
	go run examples/04-async-producer/main.go

# è¿è¡Œæ‰¹é‡æ¶ˆè´¹è€…
batch:
	@echo "ğŸŸ¢ è¿è¡Œæ‰¹é‡æ¶ˆè´¹è€…..."
	go run examples/05-batch-consumer/main.go

# è¿è¡Œè®¢å•å¤„ç†ç³»ç»Ÿ
order:
	@echo "ğŸ“¦ è¿è¡Œè®¢å•å¤„ç†ç³»ç»Ÿ..."
	go run examples/08-order-processing/main.go

# æµ‹è¯•æ‰€æœ‰ä»£ç 
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test -v ./...

# æ„å»ºæ‰€æœ‰ç¤ºä¾‹
build:
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰ç¤ºä¾‹..."
	@mkdir -p bin
	go build -o bin/simple-producer examples/01-simple-producer/main.go
	go build -o bin/simple-consumer examples/02-simple-consumer/main.go
	go build -o bin/async-producer examples/04-async-producer/main.go
	go build -o bin/batch-consumer examples/05-batch-consumer/main.go
	go build -o bin/order-service examples/08-order-processing/main.go
	@echo "âœ… æ„å»ºå®Œæˆï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åœ¨ bin/ ç›®å½•"

# å®‰è£…å¼€å‘å·¥å…·
install-tools:
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	golangci-lint run ./...

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ’… æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

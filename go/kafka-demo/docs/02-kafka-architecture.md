# Kafka æ¶æ„è®¾è®¡

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kafka Cluster                            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Broker 1 â”‚      â”‚ Broker 2 â”‚      â”‚ Broker 3 â”‚              â”‚
â”‚  â”‚          â”‚      â”‚          â”‚      â”‚          â”‚              â”‚
â”‚  â”‚ Topic A  â”‚      â”‚ Topic A  â”‚      â”‚ Topic B  â”‚              â”‚
â”‚  â”‚ P0-L     â”‚      â”‚ P1-L     â”‚      â”‚ P0-L     â”‚              â”‚
â”‚  â”‚ P1-F     â”‚      â”‚ P0-F     â”‚      â”‚ P1-F     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â–²                    â–²
         â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Producerâ”‚          â”‚Producerâ”‚          â”‚Producer â”‚
    â”‚   A     â”‚          â”‚   B    â”‚          â”‚   C     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Consumer â”‚          â”‚Consumerâ”‚          â”‚Consumer â”‚
    â”‚ Group 1 â”‚          â”‚Group 1 â”‚          â”‚ Group 2 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              ZooKeeper Ensemble                   â”‚
    â”‚  (åè°ƒç®¡ç† / Metadata / Leader Election)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**: 
- `P0-L`: Partition 0 Leader
- `P1-F`: Partition 1 Follower

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Broker é›†ç¾¤

#### Broker çš„èŒè´£

1. **å­˜å‚¨ç®¡ç†**
   - æŒä¹…åŒ–æ¶ˆæ¯åˆ°ç£ç›˜
   - ç®¡ç†æ—¥å¿—åˆ†æ®µ (Log Segment)
   - å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

2. **è¯·æ±‚å¤„ç†**
   - å¤„ç†ç”Ÿäº§è€…çš„å†™è¯·æ±‚
   - å¤„ç†æ¶ˆè´¹è€…çš„è¯»è¯·æ±‚
   - å¤„ç†å…ƒæ•°æ®æŸ¥è¯¢è¯·æ±‚

3. **å‰¯æœ¬ç®¡ç†**
   - Leader å‰¯æœ¬å¤„ç†è¯»å†™
   - Follower å‰¯æœ¬åŒæ­¥æ•°æ®
   - å‚ä¸ ISR (In-Sync Replicas) ç®¡ç†

4. **Controller è§’è‰²**
   - æ¯ä¸ªé›†ç¾¤é€‰ä¸¾ä¸€ä¸ª Controller
   - è´Ÿè´£åˆ†åŒº Leader é€‰ä¸¾
   - ç®¡ç†é›†ç¾¤å…ƒæ•°æ®

#### Broker é…ç½®ç¤ºä¾‹

```properties
# Broker ID (é›†ç¾¤ä¸­å”¯ä¸€)
broker.id=0

# ç›‘å¬åœ°å€
listeners=PLAINTEXT://localhost:9092

# æ—¥å¿—ç›®å½•
log.dirs=/var/lib/kafka/data

# Zookeeper è¿æ¥
zookeeper.connect=localhost:2181

# åˆ†åŒºå‰¯æœ¬æ•°
default.replication.factor=3

# æœ€å°åŒæ­¥å‰¯æœ¬æ•°
min.insync.replicas=2

# æ—¥å¿—ä¿ç•™æ—¶é—´
log.retention.hours=168
log.retention.bytes=1073741824
```

### 2. ZooKeeper (æ­£åœ¨è¢«ç§»é™¤)

#### ZooKeeper çš„ä½œç”¨

```
ä¼ ç»Ÿæ¶æ„ä¸­çš„èŒè´£ï¼š
â”œâ”€â”€ é›†ç¾¤å…ƒæ•°æ®ç®¡ç†
â”‚   â”œâ”€â”€ Broker æ³¨å†Œä¿¡æ¯
â”‚   â”œâ”€â”€ Topic é…ç½®ä¿¡æ¯
â”‚   â””â”€â”€ Partition åˆ†é…ä¿¡æ¯
â”œâ”€â”€ Controller é€‰ä¸¾
â”œâ”€â”€ Consumer Group åè°ƒ (æ—§ç‰ˆæœ¬)
â””â”€â”€ é…ç½®ç®¡ç†
```

#### KRaft æ¨¡å¼ (æ–°æ¶æ„)

ä» Kafka 2.8+ å¼€å§‹ï¼Œå¼•å…¥äº† **KRaft** (Kafka Raft) æ¨¡å¼ï¼Œç§»é™¤å¯¹ ZooKeeper çš„ä¾èµ–ï¼š

```
KRaft æ¶æ„ï¼š
- ä½¿ç”¨ Raft åè®®å®ç°å…±è¯†
- å†…ç½®å…ƒæ•°æ®ç®¡ç†
- ç®€åŒ–è¿ç»´å¤æ‚åº¦
- æå‡æ‰©å±•æ€§å’Œæ€§èƒ½
```

### 3. å­˜å‚¨ç»“æ„

#### æ—¥å¿—æ–‡ä»¶ç»„ç»‡

```
Topic: orders (Partition 0)
/var/lib/kafka/data/orders-0/
â”œâ”€â”€ 00000000000000000000.log        # æ—¥å¿—æ®µæ–‡ä»¶
â”œâ”€â”€ 00000000000000000000.index      # åç§»é‡ç´¢å¼•
â”œâ”€â”€ 00000000000000000000.timeindex  # æ—¶é—´æˆ³ç´¢å¼•
â”œâ”€â”€ 00000000000001000000.log
â”œâ”€â”€ 00000000000001000000.index
â””â”€â”€ 00000000000001000000.timeindex
```

#### æ—¥å¿—æ®µ (Log Segment)

```
ç‰¹ç‚¹ï¼š
- æ¯ä¸ªåˆ†åŒºåˆ†ä¸ºå¤šä¸ªæ—¥å¿—æ®µ
- é»˜è®¤å¤§å° 1GB æˆ– 1 å‘¨
- åªæœ‰æœ€åä¸€ä¸ªæ®µæ˜¯æ´»è·ƒçš„ï¼ˆå¯å†™ï¼‰
- æ”¯æŒæŒ‰æ—¶é—´æˆ–å¤§å°æ¸…ç†æ—§æ®µ
```

#### æ¶ˆæ¯å­˜å‚¨æ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Message Batch                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Offset: 100                                      â”‚
â”‚ Timestamp: 2025-11-06T10:00:00Z                 â”‚
â”‚ Key: "user-123" (serialized)                    â”‚
â”‚ Value: "{...}" (serialized)                     â”‚
â”‚ Headers: [{"source": "web"}]                    â”‚
â”‚ CRC: 0x12345678                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. å‰¯æœ¬æœºåˆ¶ (Replication)

#### ISR (In-Sync Replicas)

```
ISR: ä¸ Leader ä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Partition 0 (Replication Factor: 3)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Broker 1: Leader (ISR)                  â”‚
â”‚ Broker 2: Follower (ISR) âœ“             â”‚
â”‚ Broker 3: Follower (ISR) âœ“             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¦‚æœ Broker 3 å»¶è¿Ÿè¿‡é«˜ï¼š
â”‚ Broker 1: Leader (ISR)                  â”‚
â”‚ Broker 2: Follower (ISR) âœ“             â”‚
â”‚ Broker 3: Follower (Out-of-Sync) âœ—     â”‚
```

#### ACK æœºåˆ¶

```go
// acks = 0: ä¸ç­‰å¾…ç¡®è®¤ï¼ˆæœ€å¿«ï¼Œå¯èƒ½ä¸¢å¤±ï¼‰
Producer -> Broker
           âœ“ ç«‹å³è¿”å›

// acks = 1: ç­‰å¾… Leader ç¡®è®¤ï¼ˆå¹³è¡¡ï¼‰
Producer -> Leader -> ç¡®è®¤
           âœ“

// acks = all: ç­‰å¾… ISR å…¨éƒ¨ç¡®è®¤ï¼ˆæœ€å¯é ï¼‰
Producer -> Leader -> Follower 1 -> ç¡®è®¤
                   -> Follower 2 -> âœ“
```

#### Leader é€‰ä¸¾

```
åœºæ™¯ï¼šLeader å¤±æ•ˆ

Before:
â”œâ”€â”€ Broker 1: Leader (å¤±æ•ˆ âœ—)
â”œâ”€â”€ Broker 2: Follower (ISR)
â””â”€â”€ Broker 3: Follower (ISR)

After:
â”œâ”€â”€ Broker 1: - (å¤±æ•ˆ)
â”œâ”€â”€ Broker 2: Leader (æ–°é€‰ä¸¾)
â””â”€â”€ Broker 3: Follower (ISR)

é€‰ä¸¾è§„åˆ™ï¼š
1. åªèƒ½ä» ISR ä¸­é€‰ä¸¾
2. é€‰æ‹©åç§»é‡æœ€å¤§çš„å‰¯æœ¬
3. Controller å‘èµ·é€‰ä¸¾
```

## æ•°æ®æµè½¬è¿‡ç¨‹

### ç”Ÿäº§è€…å‘é€æµç¨‹

```
1. Producer æ„é€ æ¶ˆæ¯
        â†“
2. åºåˆ—åŒ– Key/Value
        â†“
3. é€‰æ‹© Partition
   - æŒ‡å®š Partition
   - åŸºäº Key Hash
   - Round-robin
        â†“
4. åŠ å…¥æ‰¹æ¬¡ (Batch)
        â†“
5. å‘é€åˆ° Broker (Leader)
        â†“
6. Leader å†™å…¥æœ¬åœ°æ—¥å¿—
        â†“
7. Follower æ‹‰å–åŒæ­¥
        â†“
8. è¿”å›ç¡®è®¤ (æ ¹æ® acks)
```

### æ¶ˆè´¹è€…æ¶ˆè´¹æµç¨‹

```
1. Consumer åŠ å…¥ Consumer Group
        â†“
2. è§¦å‘ Rebalance (åˆ†åŒºåˆ†é…)
        â†“
3. è·å–åˆ†é…çš„ Partition
        â†“
4. ä» Offset ä½ç½®å¼€å§‹æ‹‰å–
        â†“
5. ååºåˆ—åŒ–æ¶ˆæ¯
        â†“
6. ä¸šåŠ¡å¤„ç†
        â†“
7. æäº¤ Offset
   - è‡ªåŠ¨æäº¤
   - æ‰‹åŠ¨æäº¤
```

### Rebalance (é‡å¹³è¡¡)

**è§¦å‘æ¡ä»¶**:
- æ–°æ¶ˆè´¹è€…åŠ å…¥
- æ¶ˆè´¹è€…ç¦»å¼€æˆ–å´©æºƒ
- Topic åˆ†åŒºæ•°å˜åŒ–
- æ¶ˆè´¹è€…è®¢é˜…æ”¹å˜

**Rebalance è¿‡ç¨‹**:
```
1. åœæ­¢æ¶ˆè´¹ (Stop The World)
2. æ’¤é”€å½“å‰åˆ†åŒºåˆ†é…
3. é‡æ–°åˆ†é…åˆ†åŒº
4. æ¢å¤æ¶ˆè´¹

å½±å“ï¼š
- çŸ­æš‚çš„æ¶ˆè´¹æš‚åœ
- å¯èƒ½å¯¼è‡´é‡å¤æ¶ˆè´¹
- éœ€è¦é‡æ–°å»ºç«‹è¿æ¥
```

**åˆ†é…ç­–ç•¥**:

1. **Range** (èŒƒå›´åˆ†é…)
```
Topic: orders (4 ä¸ªåˆ†åŒº)
Consumer Group: 2 ä¸ªæ¶ˆè´¹è€…

Consumer-1: [P0, P1]
Consumer-2: [P2, P3]
```

2. **RoundRobin** (è½®è¯¢åˆ†é…)
```
Topic A: [P0, P1]
Topic B: [P0, P1]

Consumer-1: [A-P0, B-P1]
Consumer-2: [A-P1, B-P0]
```

3. **Sticky** (ç²˜æ€§åˆ†é…)
```
ç‰¹ç‚¹ï¼š
- å°½é‡ä¿æŒä¹‹å‰çš„åˆ†é…
- å‡å°‘æ•°æ®è¿ç§»
- ä¼˜åŒ– Rebalance æ€§èƒ½
```

## æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. é›¶æ‹·è´ (Zero Copy)

```
ä¼ ç»Ÿ IO:
Disk -> Kernel Buffer -> User Buffer -> Socket Buffer -> NIC

é›¶æ‹·è´ (sendfile):
Disk -> Kernel Buffer -> NIC
        â†“
    å‡å°‘ 2 æ¬¡æ‹·è´
```

### 2. æ‰¹å¤„ç†

```
- Producer æ‰¹é‡å‘é€
- Consumer æ‰¹é‡æ‹‰å–
- å‡å°‘ç½‘ç»œå¼€é”€
- æé«˜ååé‡
```

### 3. é¡ºåºå†™å…¥

```
- æ¶ˆæ¯è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶æœ«å°¾
- é¡ºåºç£ç›˜å†™å…¥æ€§èƒ½æ¥è¿‘å†…å­˜
- é¿å…éšæœº IO
```

### 4. é¡µç¼“å­˜ (Page Cache)

```
- åˆ©ç”¨æ“ä½œç³»ç»Ÿé¡µç¼“å­˜
- è¯»å–æ—¶ä¼˜å…ˆä»ç¼“å­˜è·å–
- å‡å°‘ç£ç›˜ IO
```

### 5. æ¶ˆæ¯å‹ç¼©

```
æ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼š
- gzip: å‹ç¼©ç‡é«˜ï¼ŒCPU æ¶ˆè€—å¤§
- snappy: å¹³è¡¡å‹ç¼©ç‡å’Œé€Ÿåº¦
- lz4: é€Ÿåº¦å¿«ï¼Œå‹ç¼©ç‡ä¸­ç­‰
- zstd: æ–°ç®—æ³•ï¼Œç»¼åˆæœ€ä¼˜
```

## å¯é æ€§ä¿è¯

### æ•°æ®ä¸ä¸¢å¤±

**Producer ç«¯**:
```properties
acks=all                    # ç­‰å¾…æ‰€æœ‰ ISR ç¡®è®¤
retries=3                   # å¤±è´¥é‡è¯•
enable.idempotence=true     # å¹‚ç­‰æ€§ä¿è¯
```

**Broker ç«¯**:
```properties
min.insync.replicas=2       # æœ€å°‘åŒæ­¥å‰¯æœ¬æ•°
unclean.leader.election.enable=false  # ç¦æ­¢é ISR é€‰ä¸¾
```

**Consumer ç«¯**:
```properties
enable.auto.commit=false    # æ‰‹åŠ¨æäº¤
isolation.level=read_committed  # åªè¯»å·²æäº¤
```

### æ•°æ®æœ‰åºæ€§

```
ä¿è¯ï¼š
- å•ä¸ª Partition å†…ä¸¥æ ¼æœ‰åº
- ä½¿ç”¨ç›¸åŒ Key ç¡®ä¿è·¯ç”±åˆ°åŒä¸€åˆ†åŒº
- max.in.flight.requests.per.connection=1 (ä¸¥æ ¼æœ‰åº)
```

## ç›‘æ§æŒ‡æ ‡

### Broker æŒ‡æ ‡

```
- UnderReplicatedPartitions: æœªå……åˆ†å¤åˆ¶çš„åˆ†åŒº
- OfflinePartitionsCount: ç¦»çº¿åˆ†åŒºæ•°
- ActiveControllerCount: æ´»è·ƒ Controller æ•°
- LeaderElectionRate: Leader é€‰ä¸¾é€Ÿç‡
- BytesInPerSec / BytesOutPerSec: æµé‡é€Ÿç‡
```

### Producer æŒ‡æ ‡

```
- record-send-rate: å‘é€é€Ÿç‡
- record-error-rate: é”™è¯¯ç‡
- request-latency-avg: å¹³å‡å»¶è¿Ÿ
- buffer-available-bytes: ç¼“å†²åŒºå¯ç”¨å­—èŠ‚
```

### Consumer æŒ‡æ ‡

```
- records-consumed-rate: æ¶ˆè´¹é€Ÿç‡
- fetch-latency-avg: æ‹‰å–å»¶è¿Ÿ
- commit-latency-avg: æäº¤å»¶è¿Ÿ
- records-lag-max: æœ€å¤§æ¶ˆè´¹å»¶è¿Ÿ
```

## ä¸‹ä¸€æ­¥

- ğŸ“– é˜…è¯» [æ¶ˆæ¯æ¨¡å‹ä¸åˆ†åŒº](./03-message-partition.md)
- ğŸš€ å¼€å§‹ [ç¯å¢ƒæ­å»º](./04-setup-environment.md)
- ğŸ’» è¿è¡Œ [ç®€å•ç”Ÿäº§è€…ç¤ºä¾‹](../examples/01-simple-producer/)
